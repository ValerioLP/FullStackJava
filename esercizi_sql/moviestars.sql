/* Si vuole creare un gestionale per il cinema "MovieStars" con le seguenti caratteristiche: 

- Vogliamo memorizzare una anagrafica delle sale presenti nel cinema indicando
	+ posti, 
	+ nome
	+ città di appartenenza

- Nell'arco di una giornata, una sala può ospitare più film e un film può essere proiettato all'interno della stessa sala in momenti diversi della giornata

- Per ogni film proiettato nelle sale vogliamo gestire le seguenti informazioni: 
	+ Titolo, Anno di produzione, nazionalità, regista e il genere. 

- Per ogni film, vogliamo gestire informazioni relative agli attori: 
	+ Nome, Anno di nascita e nazionalità  */
  
 CREATE DATABASE moviestars
    WITH 
    OWNER = postgres
    ENCODING = 'UTF8'
    LC_COLLATE = 'Italian_Italy.1252'
    LC_CTYPE = 'Italian_Italy.1252'
    TABLESPACE = pg_default
    CONNECTION LIMIT = -1;
    
CREATE TABLE IF NOT EXISTS public.film
(
    codice integer NOT NULL GENERATED BY DEFAULT AS IDENTITY ( INCREMENT 1 START 1 MINVALUE 1 MAXVALUE 2147483647 CACHE 1 ),
    titolo character varying(25) COLLATE pg_catalog."default" NOT NULL,
    anno_produzione date NOT NULL,
    "nazionalità" character varying(25) COLLATE pg_catalog."default" NOT NULL,
    CONSTRAINT film_pkey PRIMARY KEY (codice)
)

CREATE TABLE IF NOT EXISTS public.genere
(
    nome character varying COLLATE pg_catalog."default" NOT NULL,
    CONSTRAINT genere_pkey PRIMARY KEY (nome)
)

CREATE TABLE IF NOT EXISTS public.artista
(
    codice_fiscale character varying(20) COLLATE pg_catalog."default" NOT NULL,
    nome character varying(25) COLLATE pg_catalog."default" NOT NULL,
    cognome character varying(25) COLLATE pg_catalog."default" NOT NULL,
    "nazionalità" character varying(25) COLLATE pg_catalog."default" NOT NULL,
    anno_nascita date NOT NULL,
    tipo character varying COLLATE pg_catalog."default" NOT NULL,
    CONSTRAINT artista_pkey PRIMARY KEY (codice_fiscale)
)

CREATE TABLE IF NOT EXISTS public.cinema
(
    codice integer NOT NULL GENERATED BY DEFAULT AS IDENTITY ( INCREMENT 1 START 1 MINVALUE 1 MAXVALUE 2147483647 CACHE 1 ),
    nome character varying(25) COLLATE pg_catalog."default" NOT NULL,
    "città" character varying(25) COLLATE pg_catalog."default" NOT NULL,
    CONSTRAINT cinema_pkey PRIMARY KEY (codice)
)

CREATE TABLE IF NOT EXISTS public.sala
(
    codice integer NOT NULL GENERATED BY DEFAULT AS IDENTITY ( INCREMENT 1 START 1 MINVALUE 1 MAXVALUE 2147483647 CACHE 1 ),
    codice_cinema integer NOT NULL,
    numero_posti smallint,
    CONSTRAINT pk_sala PRIMARY KEY (codice),
    CONSTRAINT fk_cinema FOREIGN KEY (codice_cinema)
        REFERENCES public.cinema (codice) MATCH SIMPLE
        ON UPDATE NO ACTION
        ON DELETE NO ACTION
)

CREATE TABLE IF NOT EXISTS public.spettacolo
(
    codice_sala integer NOT NULL,
    codice_film integer NOT NULL,
    orario time without time zone NOT NULL,
    data date NOT NULL,
    CONSTRAINT spettacolo_pkey PRIMARY KEY (codice_sala, codice_film, orario, data),
    CONSTRAINT fk_film FOREIGN KEY (codice_film)
        REFERENCES public.film (codice) MATCH SIMPLE
        ON UPDATE NO ACTION
        ON DELETE NO ACTION,
    CONSTRAINT fk_sala FOREIGN KEY (codice_sala)
        REFERENCES public.sala (codice) MATCH SIMPLE
        ON UPDATE NO ACTION
        ON DELETE NO ACTION
)

CREATE TABLE IF NOT EXISTS public."cast"
(
    codice_film integer NOT NULL,
    cf_artista character varying(25) COLLATE pg_catalog."default" NOT NULL,
    CONSTRAINT cast_pkey PRIMARY KEY (codice_film, cf_artista),
    CONSTRAINT fk_artista FOREIGN KEY (cf_artista)
        REFERENCES public.artista (codice_fiscale) MATCH SIMPLE
        ON UPDATE NO ACTION
        ON DELETE NO ACTION,
    CONSTRAINT fk_film FOREIGN KEY (codice_film)
        REFERENCES public.film (codice) MATCH SIMPLE
        ON UPDATE NO ACTION
        ON DELETE NO ACTION
)

CREATE TABLE IF NOT EXISTS public.appartenenza
(
    codice_film integer NOT NULL,
    nome_genere character varying COLLATE pg_catalog."default" NOT NULL,
    CONSTRAINT appartenenza_pkey PRIMARY KEY (codice_film, nome_genere),
    CONSTRAINT fk_film FOREIGN KEY (codice_film)
        REFERENCES public.film (codice) MATCH SIMPLE
        ON UPDATE NO ACTION
        ON DELETE NO ACTION,
    CONSTRAINT fk_genere FOREIGN KEY (nome_genere)
        REFERENCES public.genere (nome) MATCH SIMPLE
        ON UPDATE NO ACTION
        ON DELETE NO ACTION
)

CREATE TABLE IF NOT EXISTS public.palinsesto
(
    codice_cinema integer NOT NULL,
    codice_film integer NOT NULL,
    CONSTRAINT palinsesto_pkey PRIMARY KEY (codice_cinema, codice_film),
    CONSTRAINT fk_cinema FOREIGN KEY (codice_cinema)
        REFERENCES public.cinema (codice) MATCH SIMPLE
        ON UPDATE NO ACTION
        ON DELETE NO ACTION,
    CONSTRAINT fk_film FOREIGN KEY (codice_film)
        REFERENCES public.film (codice) MATCH SIMPLE
        ON UPDATE NO ACTION
        ON DELETE NO ACTION
)
    
insert into artista(codice_fiscale,nome,nazionalità,anno_nascita, tipo) 
		     values('XYZABC01A05H501D','Malenia','francese','2001-01-05','Attore');
insert into artista(codice_fiscale,nome,nazionalità,anno_nascita, tipo) 
		     values('XYZABC00B07H501D','Ranni','italiana','2000-02-07','Attore');
insert into artista(codice_fiscale,nome,nazionalità,anno_nascita, tipo) 
		     values('XYZABC99D12H501N','Nepheli','americana','1999-04-12','Attore');
insert into artista(codice_fiscale,nome,nazionalità,anno_nascita, tipo) 
		     values('XYZABC55B21H501S','Miyazaki','giapponese','1955-02-21','Regista');

insert into cinema(nome,città,numero_sale) 
		     values('UCI Cinema Porta di Roma','Roma', 14);
insert into cinema(nome,città,numero_sale) 
		     values('UCI Cinema Roma Est','Roma', 12);
insert into cinema(nome,città,numero_sale) 
		     values('Atlantic','Parigi', 10);
insert into cinema(nome,città,numero_sale) 
		     values('Maximo','Madrid',20);
insert into cinema(nome,città,numero_sale) 
		     values('Franx','Nizza',8);
		     
insert into film(titolo,genere,anno_produzione,nazionalità) 
		     values('The Day After Tomorrow','Fantascienza', '2004-01-01','USA');
insert into film(titolo,genere,anno_produzione,nazionalità) 
		     values('Inception','Fantascienza', '2010-01-01','USA');
insert into film(titolo,genere,anno_produzione,nazionalità) 
		     values('Iron Man','Azione', '2008-01-01','USA');
insert into film(titolo,genere,anno_produzione,nazionalità) 
		     values('Spider Man','Azione', '2002-01-01','USA');

insert into sala(codice_cinema,numero_posti) values(1,150);
insert into sala(codice_cinema,numero_posti) values(1,150);
insert into sala(codice_cinema,numero_posti) values(1,150);
insert into sala(codice_cinema,numero_posti) values(1,200);
insert into sala(codice_cinema,numero_posti) values(1,150);
insert into sala(codice_cinema,numero_posti) values(1,150);
insert into sala(codice_cinema,numero_posti) values(1,150);
insert into sala(codice_cinema,numero_posti) values(1,80);
insert into sala(codice_cinema,numero_posti) values(1,140);
insert into sala(codice_cinema,numero_posti) values(1,90);
insert into sala(codice_cinema,numero_posti) values(1,100);
insert into sala(codice_cinema,numero_posti) values(1,110);
insert into sala(codice_cinema,numero_posti) values(1,120);
insert into sala(codice_cinema,numero_posti) values(1,180);
insert into sala(codice_cinema,numero_posti) values(2,150);
insert into sala(codice_cinema,numero_posti) values(2,150);
insert into sala(codice_cinema,numero_posti) values(2,150);
insert into sala(codice_cinema,numero_posti) values(2,200);
insert into sala(codice_cinema,numero_posti) values(2,150);
insert into sala(codice_cinema,numero_posti) values(2,150);
insert into sala(codice_cinema,numero_posti) values(2,150);
insert into sala(codice_cinema,numero_posti) values(2,80);
insert into sala(codice_cinema,numero_posti) values(2,140);
insert into sala(codice_cinema,numero_posti) values(2,90);
insert into sala(codice_cinema,numero_posti) values(2,100);
insert into sala(codice_cinema,numero_posti) values(2,110);
insert into sala(codice_cinema,numero_posti) values(3,150);
insert into sala(codice_cinema,numero_posti) values(3,150);
insert into sala(codice_cinema,numero_posti) values(3,150);
insert into sala(codice_cinema,numero_posti) values(3,200);
insert into sala(codice_cinema,numero_posti) values(3,150);
insert into sala(codice_cinema,numero_posti) values(3,150);
insert into sala(codice_cinema,numero_posti) values(3,150);
insert into sala(codice_cinema,numero_posti) values(3,80);
insert into sala(codice_cinema,numero_posti) values(3,140);
insert into sala(codice_cinema,numero_posti) values(3,90);
insert into sala(codice_cinema,numero_posti) values(4,150);
insert into sala(codice_cinema,numero_posti) values(4,150);
insert into sala(codice_cinema,numero_posti) values(4,150);
insert into sala(codice_cinema,numero_posti) values(4,200);
insert into sala(codice_cinema,numero_posti) values(4,150);
insert into sala(codice_cinema,numero_posti) values(4,150);
insert into sala(codice_cinema,numero_posti) values(4,150);
insert into sala(codice_cinema,numero_posti) values(4,80);
insert into sala(codice_cinema,numero_posti) values(4,140);
insert into sala(codice_cinema,numero_posti) values(4,90);
insert into sala(codice_cinema,numero_posti) values(4,150);
insert into sala(codice_cinema,numero_posti) values(4,150);
insert into sala(codice_cinema,numero_posti) values(4,150);
insert into sala(codice_cinema,numero_posti) values(4,200);
insert into sala(codice_cinema,numero_posti) values(4,150);
insert into sala(codice_cinema,numero_posti) values(4,150);
insert into sala(codice_cinema,numero_posti) values(4,150);
insert into sala(codice_cinema,numero_posti) values(4,80);
insert into sala(codice_cinema,numero_posti) values(4,140);
insert into sala(codice_cinema,numero_posti) values(4,90);
insert into sala(codice_cinema,numero_posti) values(5,150);
insert into sala(codice_cinema,numero_posti) values(5,150);
insert into sala(codice_cinema,numero_posti) values(5,150);
insert into sala(codice_cinema,numero_posti) values(5,200);
insert into sala(codice_cinema,numero_posti) values(5,150);
insert into sala(codice_cinema,numero_posti) values(5,150);
insert into sala(codice_cinema,numero_posti) values(5,150);
insert into sala(codice_cinema,numero_posti) values(5,80);

insert into "cast"(codice_film,cf_artista) values(1,'XYZABC01A05H501D');
insert into "cast"(codice_film,cf_artista) values(3,'XYZABC01A05H501D');
insert into "cast"(codice_film,cf_artista) values(1,'XYZABC00B07H501D');
insert into "cast"(codice_film,cf_artista) values(2,'XYZABC00B07H501D');
insert into "cast"(codice_film,cf_artista) values(3,'XYZABC00B07H501D');
insert into "cast"(codice_film,cf_artista) values(1,'XYZABC55B21H501S');
insert into "cast"(codice_film,cf_artista) values(2,'XYZABC55B21H501S');
insert into "cast"(codice_film,cf_artista) values(3,'XYZABC55B21H501S');
insert into "cast"(codice_film,cf_artista) values(4,'XYZABC55B21H501S');
insert into "cast"(codice_film,cf_artista) values(2,'XYZABC99D12H501N');
insert into "cast"(codice_film,cf_artista) values(2,'XYZABC99D12H501N');

insert into genere(nome) values('Azione');
insert into genere(nome) values('Fantascienza');
insert into genere(nome) values('Fantasy');

insert into appartenenza(codice_film,nome_genere) values(1,'Azione');
insert into appartenenza(codice_film,nome_genere) values(1,'Fantascienza');
insert into appartenenza(codice_film,nome_genere) values(2,'Fantascienza');
insert into appartenenza(codice_film,nome_genere) values(3,'Azione');
insert into appartenenza(codice_film,nome_genere) values(3,'Fantascienza');
insert into appartenenza(codice_film,nome_genere) values(4,'Azione');
insert into appartenenza(codice_film,nome_genere) values(4,'Fantascienza');

insert into palinsesto(codice_cinema,codice_film) values(1,1);
insert into palinsesto(codice_cinema,codice_film) values(1,2);
insert into palinsesto(codice_cinema,codice_film) values(1,3);
insert into palinsesto(codice_cinema,codice_film) values(1,4);
insert into palinsesto(codice_cinema,codice_film) values(2,1);
insert into palinsesto(codice_cinema,codice_film) values(2,2);
insert into palinsesto(codice_cinema,codice_film) values(2,3);
insert into palinsesto(codice_cinema,codice_film) values(2,4);
insert into palinsesto(codice_cinema,codice_film) values(3,3);
insert into palinsesto(codice_cinema,codice_film) values(3,4);
insert into palinsesto(codice_cinema,codice_film) values(4,1);
insert into palinsesto(codice_cinema,codice_film) values(4,2);
insert into palinsesto(codice_cinema,codice_film) values(5,2);
insert into palinsesto(codice_cinema,codice_film) values(5,3);
insert into palinsesto(codice_cinema,codice_film) values(5,4);

INSERT INTO public.spettacolo VALUES (4, 1, '18:00:00', '2022-04-14');
INSERT INTO public.spettacolo VALUES (8, 1, '19:00:00', '2022-04-14');
INSERT INTO public.spettacolo VALUES (12, 1, '20:00:00', '2022-04-14');
INSERT INTO public.spettacolo VALUES (16, 2, '17:30:00', '2022-04-14');
INSERT INTO public.spettacolo VALUES (20, 2, '19:30:00', '2022-04-14');
INSERT INTO public.spettacolo VALUES (24, 2, '21:30:00', '2022-04-14');
INSERT INTO public.spettacolo VALUES (5, 3, '18:50:00', '2022-04-14');
INSERT INTO public.spettacolo VALUES (9, 3, '20:50:00', '2022-04-14');
INSERT INTO public.spettacolo VALUES (13, 3, '22:50:00', '2022-04-14');
INSERT INTO public.spettacolo VALUES (7, 4, '18:20:00', '2022-04-14');
INSERT INTO public.spettacolo VALUES (11, 4, '20:20:00', '2022-04-14');
INSERT INTO public.spettacolo VALUES (15, 4, '22:20:00', '2022-04-14');
INSERT INTO public.spettacolo VALUES (4, 1, '18:00:00', '2022-04-15');
INSERT INTO public.spettacolo VALUES (8, 1, '19:00:00', '2022-04-15');
INSERT INTO public.spettacolo VALUES (12, 1, '20:00:00', '2022-04-15');
INSERT INTO public.spettacolo VALUES (16, 2, '17:30:00', '2022-04-15');
INSERT INTO public.spettacolo VALUES (20, 2, '19:30:00', '2022-04-15');
INSERT INTO public.spettacolo VALUES (24, 2, '21:30:00', '2022-04-15');
INSERT INTO public.spettacolo VALUES (5, 3, '18:50:00', '2022-04-15');
INSERT INTO public.spettacolo VALUES (9, 3, '20:50:00', '2022-04-15');
INSERT INTO public.spettacolo VALUES (13, 3, '22:50:00', '2022-04-15');
INSERT INTO public.spettacolo VALUES (7, 4, '18:20:00', '2022-04-15');
INSERT INTO public.spettacolo VALUES (11, 4, '20:20:00', '2022-04-15');
INSERT INTO public.spettacolo VALUES (15, 4, '22:20:00', '2022-04-15');
INSERT INTO public.spettacolo VALUES (4, 1, '18:00:00', '2022-04-16');
INSERT INTO public.spettacolo VALUES (8, 1, '19:00:00', '2022-04-16');
INSERT INTO public.spettacolo VALUES (12, 1, '20:00:00', '2022-04-16');
INSERT INTO public.spettacolo VALUES (16, 2, '17:30:00', '2022-04-16');
INSERT INTO public.spettacolo VALUES (20, 2, '19:30:00', '2022-04-16');
INSERT INTO public.spettacolo VALUES (24, 2, '21:30:00', '2022-04-16');
INSERT INTO public.spettacolo VALUES (5, 3, '18:50:00', '2022-04-16');
INSERT INTO public.spettacolo VALUES (9, 3, '20:50:00', '2022-04-16');
INSERT INTO public.spettacolo VALUES (13, 3, '22:50:00', '2022-04-16');
INSERT INTO public.spettacolo VALUES (7, 4, '18:20:00', '2022-04-16');
INSERT INTO public.spettacolo VALUES (11, 4, '20:20:00', '2022-04-16');
INSERT INTO public.spettacolo VALUES (15, 4, '22:20:00', '2022-04-16');

--1- Il nome di tutti i cinema di Parigi
select nome from cinema where città = 'Parigi';
--2- Il titolo dei film di Miyazaki prodotti dopo il 2006.
create or replace view produzione as
select codice_film, film.titolo, cf_artista, artista.nome, anno_produzione, tipo from film, artista, "cast"
	where codice_film = film.codice and
	  cf_artista = artista.codice_fiscale;
select titolo from produzione where nome = 'Miyazaki' and anno_produzione > '2006-01-01';
--3- Il titolo e nazionalità dei film di fantascienza americani prodotti dopo il 2002
select * from film, genere, appartenenza
	where codice_film = film.codice and nome_genere = genere.nome and
		  anno_produzione >= '2002-01-01' and nazionalità = 'USA' ;
--4- I titolo dei film dello stesso regista di “Iron Man” (OPZIONALE)
select titolo from produzione where nome in 
	(select nome from produzione where tipo = 'Regista' and titolo = 'Iron Man');
--5- I nomi dei cinema di Roma in cui il giorno 15-04-2022 è stato proiettato un film con Ranni
select distinct nome from spettacolo, film, sala, cinema
	where sala.codice_cinema = cinema.codice and codice_sala = sala.codice and codice_film = film.codice and
	"data" =  '2022-04-15' and nome in(select distinct nome from cinema, palinsesto, film
				where codice_cinema = cinema.codice and codice_film = film.codice and film.titolo in
					(select titolo from produzione where nome = 'Ranni' and tipo = 'Attore'));
