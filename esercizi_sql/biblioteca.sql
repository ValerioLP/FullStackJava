CREATE DATABASE biblioteca
    WITH 
    OWNER = postgres
    ENCODING = 'UTF8'
    LC_COLLATE = 'Italian_Italy.1252'
    LC_CTYPE = 'Italian_Italy.1252'
    TABLESPACE = pg_default
    CONNECTION LIMIT = -1;
    
CREATE TABLE IF NOT EXISTS public.clienti
(
    id integer NOT NULL GENERATED BY DEFAULT AS IDENTITY ( INCREMENT 1 START 1 MINVALUE 1 MAXVALUE 2147483647 CACHE 1 ),
    nome character varying(25) COLLATE pg_catalog."default",
    CONSTRAINT clienti_pkey PRIMARY KEY (id)
)

TABLESPACE pg_default;

ALTER TABLE IF EXISTS public.clienti
    OWNER to postgres;

CREATE TABLE IF NOT EXISTS public.libri
(
    id integer NOT NULL GENERATED BY DEFAULT AS IDENTITY ( INCREMENT 1 START 1 MINVALUE 1 MAXVALUE 2147483647 CACHE 1 ),
    titolo character varying(25) COLLATE pg_catalog."default",
    CONSTRAINT libri_pkey PRIMARY KEY (id)
)

TABLESPACE pg_default;

ALTER TABLE IF EXISTS public.libri
    OWNER to postgres;
    
CREATE TABLE IF NOT EXISTS public.ordine_prestiti
(
    id integer NOT NULL GENERATED BY DEFAULT AS IDENTITY ( INCREMENT 1 START 1 MINVALUE 1 MAXVALUE 2147483647 CACHE 1 ),
    id_libro integer NOT NULL,
    id_cliente integer NOT NULL,
    data_inizio_prestito date NOT NULL,
    data_fine_prestito date,
    CONSTRAINT pk_ordine PRIMARY KEY (id),
    CONSTRAINT fk_cliente FOREIGN KEY (id_cliente)
        REFERENCES public.clienti (id) MATCH SIMPLE
        ON UPDATE NO ACTION
        ON DELETE NO ACTION,
    CONSTRAINT fk_libro FOREIGN KEY (id_libro)
        REFERENCES public.libri (id) MATCH SIMPLE
        ON UPDATE NO ACTION
        ON DELETE NO ACTION
)

TABLESPACE pg_default;

ALTER TABLE IF EXISTS public.ordine_prestiti
    OWNER to postgres;
    
INSERT INTO public.clienti (id, nome) VALUES (1, 'Ranni');
INSERT INTO public.clienti (id, nome) VALUES (2, 'Iji');
INSERT INTO public.clienti (id, nome) VALUES (3, 'Malenia');
INSERT INTO public.clienti (id, nome) VALUES (4, 'Marika');
INSERT INTO public.clienti (id, nome) VALUES (5, 'Ehwg');
INSERT INTO public.clienti (id, nome) VALUES (6, 'Tanith');
INSERT INTO public.clienti (id, nome) VALUES (7, 'Rykard');
INSERT INTO public.clienti (id, nome) VALUES (8, 'Godwyn');
INSERT INTO public.clienti (id, nome) VALUES (9, 'Godfrey');
INSERT INTO public.clienti (id, nome) VALUES (10, 'Radagon');
INSERT INTO public.clienti (id, nome) VALUES (11, 'Valerio');

INSERT INTO public.libri (id, titolo) VALUES (1, 'Game of Thrones');
INSERT INTO public.libri (id, titolo) VALUES (2, 'Harry Potter');
INSERT INTO public.libri (id, titolo) VALUES (3, 'Il Signore degli Anelli');
INSERT INTO public.libri (id, titolo) VALUES (4, 'La Torre Nera');
INSERT INTO public.libri (id, titolo) VALUES (5, 'Il Mondo Emerso');
INSERT INTO public.libri (id, titolo) VALUES (6, 'I Miti di Chtulu');

INSERT INTO public.ordine_prestiti (id, id_libro, id_cliente, data_inizio_prestito, data_fine_prestito) VALUES (1, 1, 1, '2022-04-12', '2022-04-30');
INSERT INTO public.ordine_prestiti (id, id_libro, id_cliente, data_inizio_prestito, data_fine_prestito) VALUES (2, 2, 1, '2022-04-10', '2022-04-30');
INSERT INTO public.ordine_prestiti (id, id_libro, id_cliente, data_inizio_prestito, data_fine_prestito) VALUES (4, 1, 7, '2022-03-31', '2022-04-15');
INSERT INTO public.ordine_prestiti (id, id_libro, id_cliente, data_inizio_prestito, data_fine_prestito) VALUES (5, 1, 5, '2022-03-31', '2022-04-15');
INSERT INTO public.ordine_prestiti (id, id_libro, id_cliente, data_inizio_prestito, data_fine_prestito) VALUES (6, 1, 9, '2022-03-31', '2022-04-15');
INSERT INTO public.ordine_prestiti (id, id_libro, id_cliente, data_inizio_prestito, data_fine_prestito) VALUES (7, 4, 8, '2022-03-31', '2022-04-15');
INSERT INTO public.ordine_prestiti (id, id_libro, id_cliente, data_inizio_prestito, data_fine_prestito) VALUES (8, 4, 2, '2022-03-31', '2022-04-15');
INSERT INTO public.ordine_prestiti (id, id_libro, id_cliente, data_inizio_prestito, data_fine_prestito) VALUES (9, 3, 10, '2022-02-10', '2022-02-28');
INSERT INTO public.ordine_prestiti (id, id_libro, id_cliente, data_inizio_prestito, data_fine_prestito) VALUES (10, 3, 9, '2022-02-12', '2022-02-28');
INSERT INTO public.ordine_prestiti (id, id_libro, id_cliente, data_inizio_prestito, data_fine_prestito) VALUES (11, 5, 1, '2022-01-12', '2022-01-31');
INSERT INTO public.ordine_prestiti (id, id_libro, id_cliente, data_inizio_prestito, data_fine_prestito) VALUES (12, 4, 9, '2022-01-09', '2022-02-12');
INSERT INTO public.ordine_prestiti (id, id_libro, id_cliente, data_inizio_prestito, data_fine_prestito) VALUES (13, 3, 8, '2022-01-12', '2022-02-12');
INSERT INTO public.ordine_prestiti (id, id_libro, id_cliente, data_inizio_prestito, data_fine_prestito) VALUES (14, 3, 1, '2022-01-12', '2022-02-12');

--creo la vista dove lavorare
create or replace view ordini_clienti as 
select clienti.id as clienti_id, nome, libri.id as libri_id, titolo, 
	data_inizio_prestito, data_fine_prestito
	from clienti, libri, ordine_prestiti
		where ordine_prestiti.id_cliente = clienti.id and 
	     	  ordine_prestiti.id_libro = libri.id;
			  
--query per tenere controllo dei dati della vista
select * from ordini_clienti order by nome asc;

--1] Tutti i libri prestati ad un utente specifico in ordine cronologico.
select titolo from ordini_clienti
	where nome = 'Ranni'
		ORDER BY data_inizio_prestito ASC;
	
--2] Individua i primi tre lettori che hanno letto pi√π libri.
select nome, count(*) as libri_letti 
	from ordini_clienti 
		where data_fine_prestito < '2022-04-12'
			group by nome
				order by libri_letti desc
					limit 3;
	
--3] Individua tutti i possessori dei libri non ancora rientrati 
--e il titolo degli stessi.
select nome, titolo, data_fine_prestito from ordini_clienti
	where data_fine_prestito > '2022-04-12';

--4] Dare lo storico dei libri chiesi in prestito da un utente 
--indicando il periodo.
select nome, titolo, data_inizio_prestito, data_fine_prestito 
	from ordini_clienti
		where nome = 'Ranni' order by data_fine_prestito desc;
	
--5] Fai la classifica dei libri maggiormente prestati.
select titolo, count(*) as numero_prestiti 
	from ordini_clienti
		group by titolo
			order by numero_prestiti desc;
